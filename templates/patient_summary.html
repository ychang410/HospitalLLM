{% extends "base.html" %}

{% block title %}병원 챗봇 - 환자 요약{% endblock %}

{% block content %}
<div class="questionnaire-container">
    <div class="text-center mb-4">
        <h2 class="mb-3">
            <i class="fas fa-user-check text-success"></i>
            질문지 작성 완료
        </h2>
        <p class="lead text-muted">의료진이 확인할 수 있도록 답변을 정리했습니다</p>
    </div>
    
    <div id="summaryContainer">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">로딩 중...</span>
            </div>
            <p class="mt-3">요약을 생성하는 중...</p>
        </div>
    </div>
    
    <div class="text-center mt-4">
        <button class="btn btn-primary btn-lg" onclick="window.location.href='/'">
            <i class="fas fa-plus"></i>
            새 환자 등록
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const patientId = {{ patient_id }};
let allResponses = [];
let aiSummary = "";

document.addEventListener('DOMContentLoaded', async function() {
    await loadAllResponses();
    await generateAISummary();
    displaySummary();
});

async function loadAllResponses() {
    try {
        // Get general question responses
        const generalResponse = await fetch(`/api/general-responses/${patientId}`);
        const generalData = await generalResponse.json();
        
        // Get personalized question responses
        const personalizedResponse = await fetch(`/api/personalized-responses/${patientId}`);
        const personalizedData = await personalizedResponse.json();
        
        allResponses = [...generalData, ...personalizedData];
        console.log('All responses:', allResponses);
    } catch (error) {
        console.error('Error loading responses:', error);
    }
}

async function generateAISummary() {
    try {
        const response = await fetch(`/api/generate-patient-summary/${patientId}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            const data = await response.json();
            aiSummary = data.summary;
        }
    } catch (error) {
        console.error('Error generating AI summary:', error);
        aiSummary = "요약 생성 중 오류가 발생했습니다.";
    }
}

function displaySummary() {
    const container = document.getElementById('summaryContainer');
    
    container.innerHTML = `
        <div class="row">
            <div class="col-md-8">
                <div class="question-block">
                    <h4 class="mb-3">
                        <i class="fas fa-robot text-primary"></i>
                        AI 요약
                    </h4>
                    <div class="ai-summary p-4 bg-light rounded">
                        <p class="mb-0">${aiSummary || "요약을 생성하고 있습니다..."}</p>
                    </div>
                </div>
                
                <div class="question-block">
                    <h4 class="mb-3">
                        <i class="fas fa-list text-info"></i>
                        모든 질문과 답변
                    </h4>
                    <div id="allResponses">
                        ${generateAllResponsesHTML()}
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="question-block">
                    <h5 class="mb-3">
                        <i class="fas fa-info-circle text-secondary"></i>
                        정보
                    </h5>
                    <p><strong>환자 ID:</strong> ${patientId}</p>
                    <p><strong>완료 일시:</strong> ${new Date().toLocaleString('ko-KR')}</p>
                    <p><strong>총 질문 수:</strong> ${allResponses.length}개</p>
                </div>
                
                <div class="question-block">
                    <h5 class="mb-3">
                        <i class="fas fa-download text-success"></i>
                        내보내기
                    </h5>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" onclick="window.print()">
                            <i class="fas fa-print"></i> 인쇄
                        </button>
                        <button class="btn btn-outline-success" onclick="downloadSummary()">
                            <i class="fas fa-file-pdf"></i> PDF 다운로드
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function generateAllResponsesHTML() {
    return allResponses.map((response, index) => `
        <div class="response-item mb-3 p-3 border rounded">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h6 class="text-primary mb-0">Q${index + 1}: ${response.question_text}</h6>
                <span class="badge ${response.is_personalized ? 'bg-info' : 'bg-secondary'}">
                    ${response.is_personalized ? '개인화' : '일반'}
                </span>
            </div>
            <p class="mb-0">
                ${response.response_text || response.response_value || '답변 없음'}
            </p>
            ${response.generated_reason ? `
                <small class="text-muted">
                    <i class="fas fa-lightbulb"></i> ${response.generated_reason}
                </small>
            ` : ''}
        </div>
    `).join('');
}

function downloadSummary() {
    // Simple text download
    const content = `
환자 ID: ${patientId}
완료 일시: ${new Date().toLocaleString('ko-KR')}

AI 요약:
${aiSummary}

질문과 답변:
${allResponses.map((r, i) => `${i+1}. ${r.question_text}\n답변: ${r.response_text || r.response_value || '답변 없음'}`).join('\n\n')}
    `;
    
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `patient_${patientId}_summary.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Print styles
const printStyles = `
    <style media="print">
        .btn, .no-print { display: none !important; }
        .question-block { 
            break-inside: avoid; 
            margin-bottom: 20px; 
            border: 1px solid #ddd !important;
            box-shadow: none !important;
        }
        body { font-size: 12px; }
        .question-text { font-size: 14px; }
        .ai-summary { 
            background: #f8f9fa !important; 
            border: 1px solid #dee2e6 !important;
        }
    </style>
`;

document.head.insertAdjacentHTML('beforeend', printStyles);
</script>
{% endblock %}
