<!-- Body Map Component - Image Based with Markers -->
<style>
.body-map-container {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 15px;
    position: relative;
    z-index: 1;
}

.body-image-wrapper {
    position: relative;
    width: 100%;
    max-width: 400px;
    margin: 0 auto;
}

.body-image {
    width: 100%;
    height: auto;
    display: block;
    border-radius: 10px;
}

.body-marker {
    position: absolute;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(244, 67, 54, 1) 0%, rgba(244, 67, 54, 0.8) 40%, rgba(244, 67, 54, 0.3) 80%, transparent 100%);
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    transform: translate(-50%, -50%);
    box-shadow: 0 2px 8px rgba(244, 67, 54, 0.4);
}

.body-marker:hover {
    width: 40px;
    height: 40px;
    background: radial-gradient(circle, rgba(255, 87, 34, 1) 0%, rgba(255, 87, 34, 0.9) 40%, rgba(255, 87, 34, 0.5) 80%, transparent 100%);
    box-shadow: 0 4px 16px rgba(255, 87, 34, 0.6);
    animation: pulse 1.5s infinite;
}

.body-marker.has-symptom {
    background: radial-gradient(circle, rgba(183, 28, 28, 1) 0%, rgba(183, 28, 28, 0.9) 40%, rgba(183, 28, 28, 0.5) 80%, transparent 100%);
    box-shadow: 0 4px 16px rgba(183, 28, 28, 0.6);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { 
        transform: translate(-50%, -50%) scale(1); 
        opacity: 1;
    }
    50% { 
        transform: translate(-50%, -50%) scale(1.1); 
        opacity: 0.8;
    }
}

.symptoms-list {
    margin-top: 20px;
    width: 100%;
}

.symptom-card {
    background: white;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
    border: 2px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.symptom-card .body-part-name {
    font-weight: bold;
    color: #495057;
}

.symptom-card .pain-level {
    color: #ff6b6b;
    font-weight: bold;
}

.symptom-card .btn-remove {
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 5px 10px;
    cursor: pointer;
}
</style>

<div class="body-map-container">
    <div class="body-image-wrapper">
        <!-- Real anatomical body image -->
        <img src="/static/body_image.jpg" class="body-image" alt="Human Body" />
        
        <!-- Clickable Markers -->
        <div class="body-marker" data-part="head" style="top: 7.8%; left: 50%;" onclick="handleBodyPartClick('head')"></div>
        <div class="body-marker" data-part="neck" style="top: 15%; left: 50%;" onclick="handleBodyPartClick('neck')"></div>
        <div class="body-marker" data-part="left_shoulder" style="top: 20%; left: 34%;" onclick="handleBodyPartClick('left_shoulder')"></div>
        <div class="body-marker" data-part="right_shoulder" style="top: 20%; left: 66%;" onclick="handleBodyPartClick('right_shoulder')"></div>
        <div class="body-marker" data-part="chest" style="top: 26%; left: 50%;" onclick="handleBodyPartClick('chest')"></div>
        <div class="body-marker" data-part="abdomen" style="top: 35%; left: 50%;" onclick="handleBodyPartClick('abdomen')"></div>
        <div class="body-marker" data-part="left_arm" style="top: 29%; left: 23%;" onclick="handleBodyPartClick('left_arm')"></div>
        <div class="body-marker" data-part="right_arm" style="top: 29%; left: 77%;" onclick="handleBodyPartClick('right_arm')"></div>
        <div class="body-marker" data-part="left_forearm" style="top: 40%; left: 21%;" onclick="handleBodyPartClick('left_forearm')"></div>
        <div class="body-marker" data-part="right_forearm" style="top: 40%; left: 79%;" onclick="handleBodyPartClick('right_forearm')"></div>
        <div class="body-marker" data-part="left_hand" style="top: 50%; left: 23.5%;" onclick="handleBodyPartClick('left_hand')"></div>
        <div class="body-marker" data-part="right_hand" style="top: 50%; left: 76.5%;" onclick="handleBodyPartClick('right_hand')"></div>
        <div class="body-marker" data-part="pelvis" style="top: 44%; left: 50%;" onclick="handleBodyPartClick('pelvis')"></div>
        <div class="body-marker" data-part="left_thigh" style="top: 57%; left: 43%;" onclick="handleBodyPartClick('left_thigh')"></div>
        <div class="body-marker" data-part="right_thigh" style="top: 57%; left: 57%;" onclick="handleBodyPartClick('right_thigh')"></div>
        <div class="body-marker" data-part="left_knee" style="top: 66.5%; left: 43%;" onclick="handleBodyPartClick('left_knee')"></div>
        <div class="body-marker" data-part="right_knee" style="top: 66.5%; left: 57%;" onclick="handleBodyPartClick('right_knee')"></div>
        <div class="body-marker" data-part="left_leg" style="top: 77%; left: 43.5%;" onclick="handleBodyPartClick('left_leg')"></div>
        <div class="body-marker" data-part="right_leg" style="top: 77%; left: 56.5%;" onclick="handleBodyPartClick('right_leg')"></div>
        <div class="body-marker" data-part="left_foot" style="top: 91%; left: 43%;" onclick="handleBodyPartClick('left_foot')"></div>
        <div class="body-marker" data-part="right_foot" style="top: 91%; left: 57%;" onclick="handleBodyPartClick('right_foot')"></div>
    </div>
</div>

<div class="symptoms-list" id="symptomsList">
    <!-- Selected symptoms will appear here -->
</div>

<!-- Symptom Input Modal -->
<div class="modal fade" id="symptomModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">증상 입력</h5>
                <button type="button" class="btn-close" onclick="closeSymptomModal()"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">선택한 부위</label>
                    <input type="text" class="form-control" id="selectedBodyPart" readonly>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">통증/불편함 정도 (1-10)</label>
                    <div class="scale-container">
                        <input type="range" class="scale-slider w-100" id="painLevel" min="1" max="10" value="5" 
                               oninput="document.getElementById('painValue').textContent = this.value">
                        <div class="scale-value text-center" id="painValue">5</div>
                        <div class="scale-labels d-flex justify-content-between">
                            <span>1 (약함)</span>
                            <span>10 (심함)</span>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">얼마나 오래 지속되고 있나요?</label>
                    <input type="text" class="form-control" id="duration" placeholder="예: 3일, 1주일, 한 달">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">추가 설명 (선택사항)</label>
                    <textarea class="form-control" id="description" rows="3" placeholder="예: 찌르는 듯한 통증, 간헐적으로 발생"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeSymptomModal()">취소</button>
                <button type="button" class="btn btn-primary" id="saveSymptom">저장</button>
            </div>
        </div>
    </div>
</div>

<script>
// Global handler function for body part clicks
function handleBodyPartClick(bodyPart) {
    console.log('CLICKED:', bodyPart);
    openSymptomModal(bodyPart);
}

// Body part Korean names
const bodyPartNames = {
    'head': '머리',
    'neck': '목',
    'left_shoulder': '왼쪽 어깨',
    'right_shoulder': '오른쪽 어깨',
    'chest': '가슴',
    'abdomen': '복부',
    'left_arm': '왼쪽 팔',
    'right_arm': '오른쪽 팔',
    'left_forearm': '왼쪽 팔뚝',
    'right_forearm': '오른쪽 팔뚝',
    'left_hand': '왼쪽 손',
    'right_hand': '오른쪽 손',
    'pelvis': '골반',
    'left_thigh': '왼쪽 허벅지',
    'right_thigh': '오른쪽 허벅지',
    'left_knee': '왼쪽 무릎',
    'right_knee': '오른쪽 무릎',
    'left_leg': '왼쪽 다리',
    'right_leg': '오른쪽 다리',
    'left_foot': '왼쪽 발',
    'right_foot': '오른쪽 발'
};

let selectedSymptoms = [];
let currentBodyPart = null;
let symptomModal = null;

// Initialize immediately
(function initBodyMap() {
    console.log('Body Map: Initializing...');
    
    setTimeout(function() {
        console.log('Body Map: Starting initialization after delay');
        
        const modalElement = document.getElementById('symptomModal');
        console.log('Body Map: Modal element found:', !!modalElement);
        console.log('Body Map: Bootstrap available:', typeof bootstrap !== 'undefined');
        
        if (modalElement && typeof bootstrap !== 'undefined') {
            symptomModal = new bootstrap.Modal(modalElement);
            console.log('Body Map: Modal initialized');
        }
        
        // Save symptom handler
        const saveBtn = document.getElementById('saveSymptom');
        if (saveBtn) {
            saveBtn.addEventListener('click', saveSymptom);
            console.log('Body Map: Save button listener added');
        }
        
        // Initialize symptoms list
        updateSymptomsList();
        console.log('Body Map: Initialization complete!');
    }, 300);
})();

function openSymptomModal(bodyPart) {
    console.log('openSymptomModal called for:', bodyPart);
    currentBodyPart = bodyPart;
    const bodyPartName = bodyPartNames[bodyPart];
    console.log('Body part name:', bodyPartName);
    
    const selectedBodyPartElement = document.getElementById('selectedBodyPart');
    const modalTitleElement = document.getElementById('modalTitle');
    
    if (!selectedBodyPartElement || !modalTitleElement) {
        console.error('Modal elements not found!');
        alert(`증상 입력 창을 열 수 없습니다. 페이지를 새로고침해주세요.`);
        return;
    }
    
    selectedBodyPartElement.value = bodyPartName;
    modalTitleElement.textContent = `${bodyPartName} 증상 입력`;
    
    // Check if symptom already exists
    const existingSymptom = selectedSymptoms.find(s => s.bodyPart === bodyPart);
    if (existingSymptom) {
        document.getElementById('painLevel').value = existingSymptom.painLevel;
        document.getElementById('painValue').textContent = existingSymptom.painLevel;
        document.getElementById('duration').value = existingSymptom.duration;
        document.getElementById('description').value = existingSymptom.description || '';
    } else {
        // Reset form
        document.getElementById('painLevel').value = 5;
        document.getElementById('painValue').textContent = 5;
        document.getElementById('duration').value = '';
        document.getElementById('description').value = '';
    }
    
    // Try to show modal
    if (symptomModal) {
        console.log('Showing modal using Bootstrap');
        symptomModal.show();
    } else {
        console.log('Bootstrap modal not available, trying jQuery');
        if (typeof $ !== 'undefined') {
            $('#symptomModal').modal('show');
        } else {
            console.log('Using manual modal display');
            const modalElement = document.getElementById('symptomModal');
            if (modalElement) {
                modalElement.style.display = 'block';
                modalElement.classList.add('show');
                document.body.classList.add('modal-open');
                
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show';
                backdrop.id = 'modalBackdrop';
                document.body.appendChild(backdrop);
            }
        }
    }
}

function closeSymptomModal() {
    console.log('Closing modal');
    if (symptomModal) {
        symptomModal.hide();
    } else {
        const modalElement = document.getElementById('symptomModal');
        if (modalElement) {
            modalElement.style.display = 'none';
            modalElement.classList.remove('show');
            document.body.classList.remove('modal-open');
            
            const backdrop = document.getElementById('modalBackdrop');
            if (backdrop) {
                backdrop.remove();
            }
        }
    }
}

function saveSymptom() {
    const painLevel = document.getElementById('painLevel').value;
    const duration = document.getElementById('duration').value;
    const description = document.getElementById('description').value;
    
    if (!duration) {
        alert('지속 기간을 입력해주세요.');
        return;
    }
    
    // Remove existing symptom if any
    selectedSymptoms = selectedSymptoms.filter(s => s.bodyPart !== currentBodyPart);
    
    // Add new symptom
    selectedSymptoms.push({
        bodyPart: currentBodyPart,
        bodyPartName: bodyPartNames[currentBodyPart],
        painLevel: parseInt(painLevel),
        duration: duration,
        description: description
    });
    
    // Update UI
    updateBodyPartHighlight(currentBodyPart, true);
    updateSymptomsList();
    
    closeSymptomModal();
}

function updateBodyPartHighlight(bodyPart, hasSymptom) {
    const marker = document.querySelector(`.body-marker[data-part="${bodyPart}"]`);
    if (marker) {
        if (hasSymptom) {
            marker.classList.add('has-symptom');
        } else {
            marker.classList.remove('has-symptom');
        }
    }
}

function updateSymptomsList() {
    const container = document.getElementById('symptomsList');
    
    if (selectedSymptoms.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">선택된 증상이 없습니다. 신체 부위의 파란 점을 클릭해주세요.</p>';
        return;
    }
    
    container.innerHTML = `
        <h6 class="mb-3">선택된 증상 (${selectedSymptoms.length}개)</h6>
        ${selectedSymptoms.map(symptom => `
            <div class="symptom-card">
                <div>
                    <div class="body-part-name">${symptom.bodyPartName}</div>
                    <div><small class="text-muted">통증: </small><span class="pain-level">${symptom.painLevel}/10</span></div>
                    <div><small class="text-muted">기간: ${symptom.duration}</small></div>
                    ${symptom.description ? `<div><small>${symptom.description}</small></div>` : ''}
                </div>
                <button class="btn-remove" onclick="removeSymptom('${symptom.bodyPart}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `).join('')}
    `;
}

function removeSymptom(bodyPart) {
    selectedSymptoms = selectedSymptoms.filter(s => s.bodyPart !== bodyPart);
    updateBodyPartHighlight(bodyPart, false);
    updateSymptomsList();
}

function getSelectedSymptoms() {
    return selectedSymptoms;
}

// Make function globally available
window.getBodyMapSymptoms = getSelectedSymptoms;
</script>
